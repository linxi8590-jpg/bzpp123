<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>启明字库编辑器</title>
  <link rel="stylesheet" href="./patch-editor.css" />
</head>
<body>
  <header class="top">
    <div class="title">
      <h1>启明字库编辑器</h1>
      <div class="sub">手机友好：导入/编辑/去重/导出 qiming_patch.json（v1.1 自动清洗）</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>1) 载入字库</h2>
      <div class="row">
        <button id="btnLoadRemote">读取仓库 qiming_patch.json</button>
        <label class="btn">
          导入本地文件
          <input id="fileInput" type="file" accept="application/json,.json" hidden />
        </label>
        <button id="btnNew">新建空字库</button>
      </div>
      <div class="meta">
        <span class="pill">状态</span><span id="status" class="bad">未载入</span>
        <span class="pill">字数</span><span id="count">0</span>
        <span class="pill">冲突</span><span id="conflicts">0</span>
      </div>
      <p class="hint">
        “读取仓库”会请求同目录下的 <code>qiming_patch.json</code>。
        如果仓库还没有这个文件，请先创建：<code>{"chars":{}}</code>。
      </p>
    </section>

    <section class="card">
      <h2>2) 添加 / 修改单字</h2>
      <div class="grid">
        <label>
          <span>汉字</span>
          <input id="char" maxlength="1" placeholder="如：锦" />
        </label>
        <label>
          <span>笔画</span>
          <input id="stroke" inputmode="numeric" placeholder="如：16" />
        </label>
        <label>
          <span>五行</span>
          <select id="wuxing">
            <option value="">（可空）</option>
            <option value="金">金</option>
            <option value="木">木</option>
            <option value="水">水</option>
            <option value="火">火</option>
            <option value="土">土</option>
          </select>
        </label>
        <label class="wide">
          <span>释义</span>
          <input id="mean" placeholder="一句话释义（可空）" />
        </label>
      </div>

      <div class="row">
        <button id="btnUpsert">写入 / 覆盖</button>
        <button id="btnDelete" class="danger">删除此字</button>
        <button id="btnClearForm" class="ghost">清空输入</button>
      </div>
      <p class="hint">同一个字重复写入会自动覆盖旧值，这就是最简单的“去重”。</p>
    </section>

    <section class="card">
      <h2>3) 粘贴合并（给 Gemini 输出用）</h2>
      <p class="hint">
        支持：<code>{"chars":{...}}</code> 或直接 <code>{"锦":{...}}</code>。你可以多段粘贴。
        <br/>v1.1 会自动清洗常见污染：代码块、中文引号、全角逗号、注释、尾部多余符号、对象尾逗号。
      </p>
      <textarea id="paste" placeholder="把 Gemini 生成的一坨 JSON 粘贴到这里..."></textarea>
      <div class="row">
        <button id="btnMerge">合并 + 去重</button>
        <button id="btnSort" class="ghost">只排序</button>
        <button id="btnValidatePaste" class="ghost">只校验粘贴区</button>
      </div>
      <div id="mergeReport" class="report"></div>
      <details class="details">
        <summary>查看清洗后的文本（排查用）</summary>
        <pre id="cleaned" class="pre"></pre>
      </details>
    </section>

    <section class="card">
      <h2>4) 查找与浏览</h2>
      <div class="row">
        <input id="search" class="search" placeholder="搜索：字 / 五行 / 释义..." />
        <button id="btnCopyCharList" class="ghost">复制所有字列表</button>
      </div>
      <div id="list" class="list"></div>
      <p class="hint">点列表里的字会自动回填到上面表单，方便你改笔画/五行/释义。</p>
    </section>

    <section class="card">
      <h2>5) 导出</h2>
      <div class="row">
        <button id="btnDownload">下载 qiming_patch.json</button>
        <button id="btnCopyJson">复制 JSON</button>
        <button id="btnValidateAll" class="ghost">校验当前字库</button>
      </div>
      <details class="details">
        <summary>查看输出 JSON</summary>
        <pre id="out" class="pre">(先载入或新建字库)</pre>
      </details>
      <p class="hint">
        iPhone 上通常不能“直接写回原文件”，最稳是：下载新文件 → 上传覆盖仓库。
      </p>
    </section>

    <footer class="foot">
      <div class="small">
        放在同仓库根目录后，用 Pages 打开：<code>/patch-editor.html</code>
      </div>
    </footer>
  </main>

  <script src="./patch-editor.js"></script>
</body>
</html>
