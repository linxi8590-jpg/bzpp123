<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- v11.13a: iOS 主屏幕“类 App”模式支持 -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="八字工具" />
<meta name="theme-color" content="#0f1115" />

<!-- 主屏幕图标（你上传同名 PNG 即可生效） -->
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png" />
<link rel="icon" sizes="192x192" href="icon-192.png" />
<link rel="icon" sizes="512x512" href="icon-512.png" />

  <title>八字排盘小工具 v11.13a（黄历 / 神煞）</title>

  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>

  

  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <div class="container">
    <h1 class="title">🔮 八字排盘小工具 v11.13a</h1>
    <p class="subtitle">
      在 v5 的基础上新增：<b>黄历/万年历</b> 与 <b>神煞学习页</b>；排盘页增加“神煞（试行版）”。<br/>
      神煞自动判定已扩展为<strong>“地支组合法 + 部分干支/日柱规则”</strong>：桃花 / 驿马 / 华盖 / 将星，以及文昌、天乙、国印、太极、禄神、羊刃、飞刃、血刃、红鸾、天喜、六合、魁罡、十恶大败、孤鸾、阴阳差错等。未覆盖者仍保留学习表，后续可继续补齐。<br/>
      *本工具用于学习与日常参考，神煞与喜用皆非单点定论。
    </p>

    <div class="tabs">
      <div class="tab-btn active" id="tabBazi">排盘</div>
      <div class="tab-btn" id="tabJieqi">节气</div>
      <div class="tab-btn" id="tabLuck">运势</div>
      <div class="tab-btn" id="tabAlmanac">黄历</div>
      <div class="tab-btn" id="tabShenSha">神煞</div>
      <div class="tab-btn" id="tabName">起名</div>
    </div>

    <!-- 排盘面板 -->
    <div class="panel active" id="panelBazi">
      <div class="picker">
        <div class="mode-row">
          <div class="mode-pill active" id="solarModeBtn">公历输入</div>
          <div class="mode-pill" id="lunarModeBtn">农历输入</div>
        </div>

        <div class="row">
          <span class="label" id="yearLabel">公历年</span>
          <input type="range" id="yearRange" />
          <span class="value" id="yearVal"></span>
        </div>

        <div class="row">
          <span class="label" id="monthLabel">公历月</span>
          <input type="range" id="monthRange" />
          <span class="value" id="monthVal"></span>
        </div>

        <div class="leap-row" id="leapRow">
          <span class="label">闰月</span>
          <label class="toggle">
            <input type="checkbox" id="leapToggle" />
            <span>若该年有闰此月才有效</span>
          </label>
        </div>

        <div class="row">
          <span class="label" id="dayLabel">公历日</span>
          <input type="range" id="dayRange" />
          <span class="value" id="dayVal"></span>
        </div>

        <div class="row">
          <span class="label">小时</span>
          <input type="range" id="hourRange" />
          <span class="value" id="hourVal"></span>
        </div>

        <div class="row" id="minuteRow" style="display:none;">
          <span class="label">分钟</span>
          <input type="range" id="minuteRange" />
          <span class="value" id="minuteVal"></span>
        </div>

        <div class="leap-row" id="minuteToggleRow" style="display:grid;">
          <span class="label">精细</span>
          <label class="toggle">
            <input type="checkbox" id="minuteToggle" />
            <span>开启分钟滑条</span>
          </label>
        </div>

        
        <div class="section" id="genderPickSection">
          <div class="section-title">性别（用于大运方向/部分神煞）</div>
          <div class="mode-row" style="grid-template-columns:1fr 1fr;">
            <div class="mode-pill active" id="pickMaleBtn">男</div>
            <div class="mode-pill" id="pickFemaleBtn">女</div>
          </div>
          <div class="small-note">此处选择会同步到“旺衰·运势”的性别参数。</div>
        </div>


<div class="section" id="adultStrengthSection">
  <div class="section-title">成人神煞判定强度</div>
  <div class="mode-row" style="grid-template-columns:1fr 1fr 1fr;">
    <div class="mode-pill" id="pickStrictBtn" data-level="strict">严格</div>
    <div class="mode-pill active" id="pickBalancedBtn" data-level="balanced">标准</div>
    <div class="mode-pill" id="pickLooseBtn" data-level="loose">宽松</div>
  </div>
  <div class="small-note">严格：隐藏提示型/简化口径（学堂、词馆、三奇贵人、科甲星）。标准：默认推荐。宽松：用于对照民间口径。</div>
</div>

<div class="quick">
          <div class="pill" id="nowPill">当前时间</div>
          <div class="pill" id="linxiPill">林曦预设</div>
          <div class="pill" id="yaoPill">曜预设</div>
        </div>

        <div class="actions">
          <button class="btn" id="calcBtn">开始排盘</button>
          <button class="btn secondary" id="copyBtn" disabled>复制结果</button>
        </div>

        <div class="actions">
          <button class="btn secondary" id="setABtn">设为 A 盘</button>
          <button class="btn secondary" id="compareBtn">用当前作 B 盘对照</button>
        </div>

        <div class="small-note" id="pickedText"></div>
        <div class="small-note" id="crossText"></div>
      </div>

      <div id="result" class="result-box" aria-live="polite">
        <div class="info" id="lunarInfo"></div>

        <div class="section">
          <div class="section-title">节气（当前 / 上一 / 下一）</div>
          <div class="jieqi-line" id="jieqiLine"></div>
        </div>

        <div class="section">
          <div class="section-title">四柱</div>
          <div class="bazi-grid">
            <div class="pillar">
              <span class="p-label">年柱</span>
              <span class="gan" id="yearGan"></span>
              <span class="zhi" id="yearZhi"></span>
              <div class="sub" id="yearSub"></div>
            </div>
            <div class="pillar">
              <span class="p-label">月柱</span>
              <span class="gan" id="monthGan"></span>
              <span class="zhi" id="monthZhi"></span>
              <div class="sub" id="monthSub"></div>
            </div>
            <div class="pillar">
              <span class="p-label">日柱</span>
              <span class="gan" id="dayGan"></span>
              <span class="zhi" id="dayZhi"></span>
              <div class="sub" id="daySub"></div>
            </div>
            <div class="pillar">
              <span class="p-label">时柱</span>
              <span class="gan" id="timeGan"></span>
              <span class="zhi" id="timeZhi"></span>
              <div class="sub" id="timeSub"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">神煞（自动判定 · 扩展版）</div>
          <div class="jieqi-line" id="ssInlineResult"></div>
          <!-- v10.4: 学习表未自动化条目提示 -->
          <details class="ss-missing" id="ssMissingBox">
            <summary>查看学习表中尚未自动化的成人神煞清单</summary>
            <div class="ss-missing-hint">这些条目已收录在“神煞学习表”，但尚未写入自动判定规则。你后续若想继续扩展，我会按“查法清晰度”分批加入。</div>
            <div id="ssMissingList" class="ss-missing-list"></div>
          </details>
          <!-- v11.0: 小儿关煞未自动化条目提示 -->
          <details class="ss-missing ss-missing--child" id="cgMissingBox">
            <summary>查看学习表中尚未自动化的小儿关煞清单</summary>
            <div class="ss-missing-hint">这些条目已收录在“小儿关煞学习表”，但尚未写入排盘页自动提示规则。</div>
            <div id="cgMissingList" class="ss-missing-list"></div>
          </details>
          <div class="small-note">已内置自动判定：桃花 / 驿马 / 华盖 / 将星 + 部分干支/日柱类（文昌、天乙、国印、太极、禄神、羊刃、飞刃、血刃、红鸾、天喜、六合、魁罡、十恶大败、孤鸾、阴阳差错、地扫星、八败、流霞、铁板、铁扫把、埋儿煞等）+ 小儿关煞的部分时辰/月份/日干规则（短命关、四柱关、雷公打脑关、金锁关、无情关、五鬼关、天狗关、断桥关）。其余仍以“神煞”页学习表为准。</div>
        </div>

        <div class="compare-box" id="compareBox">
          <div class="compare-title">
            <span>对照盘（A vs B）</span>
            <button class="btn secondary" id="clearCompareBtn" style="padding:6px 10px; font-size:11px; border-radius:10px;">清空A盘</button>
          </div>
          <div class="compare-grid">
            <div class="compare-card">
              <div class="tag">A 盘</div>
              <div class="line" id="compareALine"></div>
              <div class="meta" id="compareAMeta"></div>
            </div>
            <div class="compare-card">
              <div class="tag">B 盘</div>
              <div class="line" id="compareBLine"></div>
              <div class="meta" id="compareBMeta"></div>
            </div>
          </div>
        </div>

        <div class="copy-hint" id="tzHint"></div>
      </div>
    </div>

    <!-- 节气查询面板 -->
    <div class="panel" id="panelJieqi">
      <div class="jieqi-query">
        <div class="year-select-row">
          <span class="label">年份</span>
          <input type="range" id="jieqiYearRange" />
          <span class="value" id="jieqiYearVal"></span>
        </div>
        <div class="actions">
          <button class="btn" id="jieqiQueryBtn">查询该年二十四节气</button>
          <button class="btn secondary" id="jieqiCopyBtn" disabled>复制列表</button>
        </div>
        <div class="small-note" id="jieqiQueryHint"></div>
        <div class="jieqi-list" id="jieqiList"></div>
      </div>
    </div>

    <!-- 旺衰·运势面板 -->
    <div class="panel" id="panelLuck">
      <div class="luck-panel">
        <div class="luck-mode-row">
          <div class="luck-pill active" id="luckWsPill">身强弱·喜用</div>
          <div class="luck-pill" id="luckFlowPill">流年·大运</div>
        </div>

        <div class="luck-box active" id="wsBox">
          <div class="section-title">基于当前排盘时间（与“排盘”页一致）</div>
          <div class="actions">
            <button class="btn" id="wsCalcBtn">计算旺衰与喜用</button>
            <button class="btn secondary" id="wsCopyBtn" disabled>复制说明</button>
          </div>
          <div class="small-note">算法为“简化子平旺衰权重模型”，强调可解释与学习对照。</div>

          <div class="section" id="wsResult" style="display:none;">
            <div class="section-title">结论</div>
            <div class="jieqi-line" id="wsConclusion"></div>
            <div class="explain" id="wsExplain"></div>
          </div>
        </div>

        <div class="luck-box" id="flowBox">
          <div class="section-title">流年预览（默认近十年）</div>
          <div class="year-select-row">
            <span class="label">基准年</span>
            <input type="range" id="flowYearRange" />
            <span class="value" id="flowYearVal"></span>
          </div>
          <div class="actions">
            <button class="btn" id="flowCalcBtn">生成流年列表</button>
            <button class="btn secondary" id="flowCopyBtn" disabled>复制流年</button>
          </div>

          <div class="section">
            <div class="section-title">性别（仅用于尝试调用库的大运接口）</div>
            <div class="mode-row" style="grid-template-columns:1fr 1fr;">
              <div class="mode-pill active" id="maleBtn">男</div>
              <div class="mode-pill" id="femaleBtn">女</div>
            </div>
            <div class="small-note">只用于库的大运参数；流年列表不受影响。</div>
          </div>

          <div class="section">
            <div class="section-title">流年列表</div>
            <div class="luck-list" id="flowList"></div>
          </div>

          <div class="section">
            <div class="section-title">大运（实验性）</div>
            <div class="small-note" id="dayunHint">尝试调用 lunar-javascript 的 Yun/DaYun 接口；若库版本不含这些方法，这里会显示“不可用”。</div>
            <div class="luck-list" id="dayunList"></div>
            <div class="small-note" id="dayunExplain"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 黄历 / 万年历 -->
    <div class="panel" id="panelAlmanac">
      <div class="almanac-panel">
        <div class="almanac-row">
          <span class="label" style="color:#8b90a1; font-size:12px;">选择日期</span>
          <input class="date-input" type="date" id="almanacDate" />
        </div>

        <div class="actions">
          <button class="btn" id="almanacTodayBtn">今天</button>
          <button class="btn secondary" id="almanacCopyBtn" disabled>复制黄历</button>
        </div>

        <div class="section" id="almanacResult" style="display:none;">
          <div class="section-title">当日信息</div>
          <div class="almanac-kv" id="almanacKV"></div>
        </div>

        <div class="section" id="almanacYiJiSec" style="display:none;">
          <div class="section-title">宜 / 忌（若库支持）</div>
          <div class="almanac-kv" id="almanacYiJi"></div>
        </div>

        <div class="small-note">黄历信息优先读取库字段；若你看见“—”，说明当前 CDN 版本未暴露该接口。</div>
      </div>
    </div>

    <!-- 神煞学习页 -->
    <div class="panel" id="panelShenSha">
      <div class="shensha-panel">
        <div class="search-row">
          <input class="search-input" id="ssSearch" placeholder="搜索神煞关键词（名称/作用/查法）" />
          <div class="ss-filter-row">
            <div class="ss-pill active" id="ssFilterAll">全部</div>
            <div class="ss-pill" id="ssFilterCommon">常用</div>
            <div class="ss-pill" id="ssFilterChild">小儿关煞</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn secondary" id="ssCopyListBtn">复制当前列表</button>
          <button class="btn secondary" id="ssJumpExplainBtn">看“试行版规则说明”</button>
        </div>

        <div class="section" id="ssRuleExplain" style="display:none;">
          <div class="section-title">排盘页“试行版”自动判定规则</div>
          <div class="explain" id="ssRuleText"></div>
        </div>

        <div class="ss-list" id="ssList"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>


    <!-- 起名/测名 -->
    <div class="panel" id="panelName">
      <div class="section-title">起名 · 五格简测（手动笔画版）</div>
      <div class="hint">
        这个模块是一个<strong>轻量学习/自测</strong>功能，默认采用「最常见五格算法」的简化规则。
        由于汉字笔画与流派差异较多，这里不做自动字库，改为<strong>你手动填笔画</strong>，结果会更可控也更适合学习。
      </div>

      <div class="card">
        <div class="row">
          <label>姓名</label>
          <input id="nameFullInput" type="text" placeholder="例如：张三丰 / 欧阳娜娜" maxlength="8">
        </div>

        <div class="row">
          <label>姓氏字数</label>
          <select id="nameSurnameLen">
            <option value="1" selected>单姓</option>
            <option value="2">复姓</option>
          </select>
        </div>

        <div class="row">
          <label>名字字数</label>
          <select id="nameGivenLen">
            <option value="1">单名</option>
            <option value="2" selected>双名</option>
          </select>
        </div>

        <div class="row">
          <label>笔画填写</label>
          <div id="nameStrokeInputs" class="stroke-inputs"></div>
        </div>

        <div class="row">
          <button class="primary" id="calcNameBtn">计算五格</button>
          <button class="ghost" id="resetNameBtn">清空</button>
        </div>
      </div>

      <div class="card" id="nameResultCard" style="display:none;">
        <div class="section-title">五格结果</div>
        <div class="name-grid">
          <div class="ng-item">
            <div class="ng-label">天格</div>
            <div class="ng-value" id="ngTian">-</div>
            <div class="ng-sub" id="ngTianWx">-</div>
          </div>
          <div class="ng-item">
            <div class="ng-label">人格</div>
            <div class="ng-value" id="ngRen">-</div>
            <div class="ng-sub" id="ngRenWx">-</div>
          </div>
          <div class="ng-item">
            <div class="ng-label">地格</div>
            <div class="ng-value" id="ngDi">-</div>
            <div class="ng-sub" id="ngDiWx">-</div>
          </div>
          <div class="ng-item">
            <div class="ng-label">外格</div>
            <div class="ng-value" id="ngWai">-</div>
            <div class="ng-sub" id="ngWaiWx">-</div>
          </div>
          <div class="ng-item">
            <div class="ng-label">总格</div>
            <div class="ng-value" id="ngZong">-</div>
            <div class="ng-sub" id="ngZongWx">-</div>
          </div>
        </div>

        <div class="hint" id="nameExplain">
          提示：这里的五行判定采用<strong>数理末位</strong>常见映射：
          1/2 木，3/4 火，5/6 土，7/8 金，9/0 水。用于快速学习参考。
        </div>

        <div class="card subcard">
          <div class="section-title">三才（天-人-地）</div>
          <div class="row">
            <div id="ngSanCai" class="mono">-</div>
          </div>
        </div>

        <div class="hint">
          若你之后想要更“硬核”的版本（自动字库、81数理吉凶解释、同音筛选等），我们可以另开一层高级模式慢慢加。
        </div>
      </div>
    </div>

<script>
  /* ===================== 基础引用 ===================== */
  const els = {
    tabBazi: document.getElementById('tabBazi'),
    tabJieqi: document.getElementById('tabJieqi'),
    tabLuck: document.getElementById('tabLuck'),
    tabAlmanac: document.getElementById('tabAlmanac'),
    tabShenSha: document.getElementById('tabShenSha'),
    tabName: document.getElementById('tabName'),

    panelBazi: document.getElementById('panelBazi'),
    panelJieqi: document.getElementById('panelJieqi'),
    panelLuck: document.getElementById('panelLuck'),
    panelAlmanac: document.getElementById('panelAlmanac'),
    panelShenSha: document.getElementById('panelShenSha'),
    panelName: document.getElementById('panelName'),

    solarModeBtn: document.getElementById('solarModeBtn'),
    lunarModeBtn: document.getElementById('lunarModeBtn'),

    yearLabel: document.getElementById('yearLabel'),
    monthLabel: document.getElementById('monthLabel'),
    dayLabel: document.getElementById('dayLabel'),

    yearRange: document.getElementById('yearRange'),
    monthRange: document.getElementById('monthRange'),
    dayRange: document.getElementById('dayRange'),
    hourRange: document.getElementById('hourRange'),
    minuteRange: document.getElementById('minuteRange'),

    yearVal: document.getElementById('yearVal'),
    monthVal: document.getElementById('monthVal'),
    dayVal: document.getElementById('dayVal'),
    hourVal: document.getElementById('hourVal'),
    minuteVal: document.getElementById('minuteVal'),

    leapRow: document.getElementById('leapRow'),
    leapToggle: document.getElementById('leapToggle'),

    minuteRow: document.getElementById('minuteRow'),
    minuteToggle: document.getElementById('minuteToggle'),

    nowPill: document.getElementById('nowPill'),
    linxiPill: document.getElementById('linxiPill'),
    yaoPill: document.getElementById('yaoPill'),

    calcBtn: document.getElementById('calcBtn'),
    copyBtn: document.getElementById('copyBtn'),

    setABtn: document.getElementById('setABtn'),
    compareBtn: document.getElementById('compareBtn'),
    clearCompareBtn: document.getElementById('clearCompareBtn'),

    pickedText: document.getElementById('pickedText'),
    crossText: document.getElementById('crossText'),

    result: document.getElementById('result'),
    lunarInfo: document.getElementById('lunarInfo'),
    tzHint: document.getElementById('tzHint'),

    jieqiLine: document.getElementById('jieqiLine'),

    yearGan: document.getElementById('yearGan'),
    yearZhi: document.getElementById('yearZhi'),
    monthGan: document.getElementById('monthGan'),
    monthZhi: document.getElementById('monthZhi'),
    dayGan: document.getElementById('dayGan'),
    dayZhi: document.getElementById('dayZhi'),
    timeGan: document.getElementById('timeGan'),
    timeZhi: document.getElementById('timeZhi'),

    yearSub: document.getElementById('yearSub'),
    monthSub: document.getElementById('monthSub'),
    daySub: document.getElementById('daySub'),
    timeSub: document.getElementById('timeSub'),

    ssInlineResult: document.getElementById('ssInlineResult'),

    compareBox: document.getElementById('compareBox'),
    compareALine: document.getElementById('compareALine'),
    compareAMeta: document.getElementById('compareAMeta'),
    compareBLine: document.getElementById('compareBLine'),
    compareBMeta: document.getElementById('compareBMeta'),

    jieqiYearRange: document.getElementById('jieqiYearRange'),
    jieqiYearVal: document.getElementById('jieqiYearVal'),
    jieqiQueryBtn: document.getElementById('jieqiQueryBtn'),
    jieqiCopyBtn: document.getElementById('jieqiCopyBtn'),
    jieqiQueryHint: document.getElementById('jieqiQueryHint'),
    jieqiList: document.getElementById('jieqiList'),

    luckWsPill: document.getElementById('luckWsPill'),
    luckFlowPill: document.getElementById('luckFlowPill'),
    wsBox: document.getElementById('wsBox'),
    flowBox: document.getElementById('flowBox'),

    wsCalcBtn: document.getElementById('wsCalcBtn'),
    wsCopyBtn: document.getElementById('wsCopyBtn'),
    wsResult: document.getElementById('wsResult'),
    wsConclusion: document.getElementById('wsConclusion'),
    wsExplain: document.getElementById('wsExplain'),

    flowYearRange: document.getElementById('flowYearRange'),
    flowYearVal: document.getElementById('flowYearVal'),
    flowCalcBtn: document.getElementById('flowCalcBtn'),
    flowCopyBtn: document.getElementById('flowCopyBtn'),
    flowList: document.getElementById('flowList'),

    pickMaleBtn: document.getElementById('pickMaleBtn'),
    pickFemaleBtn: document.getElementById('pickFemaleBtn'),

    maleBtn: document.getElementById('maleBtn'),
    femaleBtn: document.getElementById('femaleBtn'),
    dayunHint: document.getElementById('dayunHint'),
    dayunList: document.getElementById('dayunList'),
    dayunExplain: document.getElementById('dayunExplain'),

    /* Almanac */
    almanacDate: document.getElementById('almanacDate'),
    almanacTodayBtn: document.getElementById('almanacTodayBtn'),
    almanacCopyBtn: document.getElementById('almanacCopyBtn'),
    almanacResult: document.getElementById('almanacResult'),
    almanacKV: document.getElementById('almanacKV'),
    almanacYiJiSec: document.getElementById('almanacYiJiSec'),
    almanacYiJi: document.getElementById('almanacYiJi'),

    /* ShenSha learning */
    ssSearch: document.getElementById('ssSearch'),
    ssFilterAll: document.getElementById('ssFilterAll'),
    ssFilterCommon: document.getElementById('ssFilterCommon'),
    ssFilterChild: document.getElementById('ssFilterChild'),
    ssList: document.getElementById('ssList'),
    ssCopyListBtn: document.getElementById('ssCopyListBtn'),
    ssJumpExplainBtn: document.getElementById('ssJumpExplainBtn'),
    ssRuleExplain: document.getElementById('ssRuleExplain'),
    ssRuleText: document.getElementById('ssRuleText'),

    toast: document.getElementById('toast'),
  
    /* 起名 */
    nameFullInput: document.getElementById('nameFullInput'),
    nameSurnameLen: document.getElementById('nameSurnameLen'),
    nameGivenLen: document.getElementById('nameGivenLen'),
    nameStrokeInputs: document.getElementById('nameStrokeInputs'),
    calcNameBtn: document.getElementById('calcNameBtn'),
    resetNameBtn: document.getElementById('resetNameBtn'),
    nameResultCard: document.getElementById('nameResultCard'),
    ngTian: document.getElementById('ngTian'),
    ngRen: document.getElementById('ngRen'),
    ngDi: document.getElementById('ngDi'),
    ngWai: document.getElementById('ngWai'),
    ngZong: document.getElementById('ngZong'),
    ngTianWx: document.getElementById('ngTianWx'),
    ngRenWx: document.getElementById('ngRenWx'),
    ngDiWx: document.getElementById('ngDiWx'),
    ngWaiWx: document.getElementById('ngWaiWx'),
    ngZongWx: document.getElementById('ngZongWx'),
    ngSanCai: document.getElementById('ngSanCai'),
    nameExplain: document.getElementById('nameExplain')

  };

  const PRESETS_SOLAR = {
    linxi: { y: 1993, m: 1, d: 20, h: 20, min: 0 },
    yao:   { y: 2025, m: 5, d: 20, h: 20, min: 0 }
  };

  const MODE = { SOLAR: 'solar', LUNAR: 'lunar' };
  let currentMode = MODE.SOLAR;
  let compareA = null;

  let genderForYun = 1; // 1=男, 0=女

  /* ===== 五行十神基础 ===== */
  const GAN_INFO = {
    '甲': { e:'木', y:'阳' }, '乙': { e:'木', y:'阴' },
    '丙': { e:'火', y:'阳' }, '丁': { e:'火', y:'阴' },
    '戊': { e:'土', y:'阳' }, '己': { e:'土', y:'阴' },
    '庚': { e:'金', y:'阳' }, '辛': { e:'金', y:'阴' },
    '壬': { e:'水', y:'阳' }, '癸': { e:'水', y:'阴' }
  };
  const GEN_NEXT = { '木':'火', '火':'土', '土':'金', '金':'水', '水':'木' };
  const GEN_PREV = { '木':'水', '火':'木', '土':'火', '金':'土', '水':'金' };
  const CONTROL = { '木':'土', '火':'金', '土':'水', '金':'木', '水':'火' };
  const CONTROLLED_BY = { '木':'金', '火':'水', '土':'木', '金':'火', '水':'土' };

  const ZHI_HIDE_FALLBACK = {
    '子':'癸','丑':'己癸辛','寅':'甲丙戊','卯':'乙',
    '辰':'戊乙癸','巳':'丙戊庚','午':'丁己','未':'己丁乙',
    '申':'庚壬戊','酉':'辛','戌':'戊辛丁','亥':'壬甲'
  };

  const JIEQI_ORDER = [
    "小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨",
    "立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑",
    "白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"
  ];

  /* ===================== 工具函数 ===================== */
  function ensureLunarLib(){
    return typeof Solar !== 'undefined' && typeof Lunar !== 'undefined';
  }
  function showToast(text){
    els.toast.textContent = text;
    els.toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => els.toast.classList.remove('show'), 1200);
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function getTZ(){ return Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local'; }
  function fmtMD(date){ return `${date.getMonth()+1}月${date.getDate()}日`; }
  function fmtYMD(date){ return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`; }
  function daysInSolarMonth(y, m){ return new Date(y, m, 0).getDate(); }

  function daysInLunarMonth(y, m, isLeap){
    try{
      if(typeof Lunar === 'undefined') return 30;
      if(Lunar.fromYmdHms){
        const len = Lunar.fromYmdHms.length;
        let lunar = null;
        if(len >= 7){
          lunar = Lunar.fromYmdHms(y, m, 1, 0, 0, 0, !!isLeap);
        }else{
          lunar = Lunar.fromYmdHms(y, m, 1, 0, 0, 0);
        }
        if(lunar && typeof lunar.getMonthDays === 'function'){
          const d = lunar.getMonthDays();
          if(d >= 29 && d <= 30) return d;
        }
      }
      if(Lunar.fromYmd){
        const lunar = Lunar.fromYmd(y, m, 1);
        if(lunar && typeof lunar.getMonthDays === 'function'){
          const d = lunar.getMonthDays();
          if(d >= 29 && d <= 30) return d;
        }
      }
    }catch(e){}
    return 30;
  }

  function setActiveQuickPill(which){
    [els.nowPill, els.linxiPill, els.yaoPill].forEach(p => p.classList.remove('active'));
    if(which === 'now') els.nowPill.classList.add('active');
    if(which === 'linxi') els.linxiPill.classList.add('active');
    if(which === 'yao') els.yaoPill.classList.add('active');
  }

  function updateLabels(){
    if(currentMode === MODE.SOLAR){
      els.yearLabel.textContent = '公历年';
      els.monthLabel.textContent = '公历月';
      els.dayLabel.textContent = '公历日';
      els.leapRow.style.display = 'none';
    }else{
      els.yearLabel.textContent = '农历年';
      els.monthLabel.textContent = '农历月';
      els.dayLabel.textContent = '农历日';
      els.leapRow.style.display = 'grid';
    }
  }
  function setActiveModePill(){
    els.solarModeBtn.classList.toggle('active', currentMode === MODE.SOLAR);
    els.lunarModeBtn.classList.toggle('active', currentMode === MODE.LUNAR);
  }

  function setRangesBounds(){
    els.yearRange.min = 1900; els.yearRange.max = 2100; els.yearRange.step = 1;
    els.monthRange.min = 1; els.monthRange.max = 12; els.monthRange.step = 1;
    els.hourRange.min = 0; els.hourRange.max = 23; els.hourRange.step = 1;
    els.minuteRange.min = 0; els.minuteRange.max = 59; els.minuteRange.step = 1;

    els.jieqiYearRange.min = 1900; els.jieqiYearRange.max = 2100; els.jieqiYearRange.step = 1;
    els.flowYearRange.min = 1900; els.flowYearRange.max = 2100; els.flowYearRange.step = 1;
  }

  function updateDayRange(){
    const y = Number(els.yearRange.value);
    const m = Number(els.monthRange.value);
    const isLeap = !!els.leapToggle.checked;

    let maxDay = 30;
    if(currentMode === MODE.SOLAR){
      maxDay = daysInSolarMonth(y, m);
    }else{
      maxDay = daysInLunarMonth(y, m, isLeap);
    }

    const currentDay = Number(els.dayRange.value || 1);

    els.dayRange.min = 1;
    els.dayRange.max = maxDay;
    els.dayRange.step = 1;

    if(currentDay > maxDay){
      els.dayRange.value = maxDay;
    }else if(!els.dayRange.value){
      els.dayRange.value = 1;
    }
  }

  function setFromSolarParts(p){
    els.yearRange.value = p.y;
    els.monthRange.value = p.m;
    updateDayRange();
    els.dayRange.value = Math.min(p.d, daysInSolarMonth(p.y, p.m));
    els.hourRange.value = p.h;
    els.minuteRange.value = p.min ?? 0;
    els.leapToggle.checked = false;
    updateDayRange();
    syncValueText();
  }

  function setFromLunarParts(p){
    els.yearRange.value = p.y;
    els.monthRange.value = p.m;
    els.leapToggle.checked = !!p.isLeap;
    updateDayRange();
    els.dayRange.value = Math.min(p.d, daysInLunarMonth(p.y, p.m, !!p.isLeap));
    els.hourRange.value = p.h;
    els.minuteRange.value = p.min ?? 0;
    updateDayRange();
    syncValueText();
  }

  function setFromDate(date){
    setFromSolarParts({
      y: date.getFullYear(),
      m: date.getMonth() + 1,
      d: date.getDate(),
      h: date.getHours(),
      min: date.getMinutes()
    });
  }

  function createLunarFromSliders(){
    const y = Number(els.yearRange.value);
    const m = Number(els.monthRange.value);
    const d = Number(els.dayRange.value);
    const h = Number(els.hourRange.value);
    const min = Number(els.minuteRange.value || 0);
    const isLeap = !!els.leapToggle.checked;

    try{
      if(Lunar.fromYmdHms){
        if(Lunar.fromYmdHms.length >= 7){
          return Lunar.fromYmdHms(y, m, d, h, min, 0, isLeap);
        }
        return Lunar.fromYmdHms(y, m, d, h, min, 0);
      }
      if(Lunar.fromYmd){
        return Lunar.fromYmd(y, m, d);
      }
    }catch(e){
      return null;
    }
    return null;
  }

  function convertSolarSlidersToLunarSliders(){
    if(!ensureLunarLib()) return;

    const y = Number(els.yearRange.value);
    const m = Number(els.monthRange.value);
    const d = Number(els.dayRange.value);
    const h = Number(els.hourRange.value);
    const min = Number(els.minuteRange.value || 0);

    try{
      const solar = Solar.fromYmdHms(y, m, d, h, min, 0);
      const lunar = solar.getLunar();

      const lunarMonth = typeof lunar.getMonth === 'function' ? lunar.getMonth() : m;
      const lunarDay = typeof lunar.getDay === 'function' ? lunar.getDay() : d;
      const lunarYear = typeof lunar.getYear === 'function' ? lunar.getYear() : y;
      const isLeap = typeof lunar.isLeap === 'function' ? lunar.isLeap() : false;

      setFromLunarParts({ y: lunarYear, m: lunarMonth, d: lunarDay, h: h, min, isLeap });

    }catch(e){
      setFromLunarParts({ y, m, d, h, min, isLeap: false });
    }
  }

  function convertLunarSlidersToSolarSliders(){
    if(!ensureLunarLib()) return;

    const lunar = createLunarFromSliders();
    if(!lunar) return;

    try{
      const solar = lunar.getSolar();
      setFromSolarParts({
        y: solar.getYear(),
        m: solar.getMonth(),
        d: solar.getDay(),
        h: solar.getHour(),
        min: solar.getMinute ? solar.getMinute() : Number(els.minuteRange.value || 0)
      });
    }catch(e){}
  }

  function switchMode(toMode){
    if(toMode === currentMode) return;

    if(toMode === MODE.LUNAR){
      convertSolarSlidersToLunarSliders();
    }else{
      convertLunarSlidersToSolarSliders();
    }

    currentMode = toMode;
    setActiveModePill();
    updateLabels();
    updateDayRange();
    syncValueText();
  }

  function getSelectedSolarParts(){
    if(currentMode === MODE.SOLAR){
      return {
        y: Number(els.yearRange.value),
        m: Number(els.monthRange.value),
        d: Number(els.dayRange.value),
        h: Number(els.hourRange.value),
        min: Number(els.minuteRange.value || 0)
      };
    }

    const lunar = createLunarFromSliders();
    if(lunar){
      const solar = lunar.getSolar();
      return {
        y: solar.getYear(),
        m: solar.getMonth(),
        d: solar.getDay(),
        h: solar.getHour(),
        min: solar.getMinute ? solar.getMinute() : Number(els.minuteRange.value || 0)
      };
    }

    return {
      y: Number(els.yearRange.value),
      m: Number(els.monthRange.value),
      d: Number(els.dayRange.value),
      h: Number(els.hourRange.value),
      min: Number(els.minuteRange.value || 0)
    };
  }

  /* ===================== 十神相关 ===================== */
  function shiShenForGan(dayGan, otherGan){
    const dm = GAN_INFO[dayGan];
    const og = GAN_INFO[otherGan];
    if(!dm || !og) return '';

    const samePol = dm.y === og.y;
    if(dm.e === og.e) return samePol ? '比肩' : '劫财';
    if(GEN_NEXT[dm.e] === og.e) return samePol ? '食神' : '伤官';
    if(GEN_PREV[dm.e] === og.e) return samePol ? '偏印' : '正印';
    if(CONTROL[dm.e] === og.e) return samePol ? '偏财' : '正财';
    if(CONTROLLED_BY[dm.e] === og.e) return samePol ? '七杀' : '正官';
    return '';
  }

  function hiddenGansForZhi(zhi){
    try{
      if(typeof LunarUtil !== 'undefined'){
        const map = LunarUtil.ZHI_HIDE_GAN || LunarUtil.ZHI_HIDE_GAN_MAP;
        if(map && map[zhi]){
          const v = map[zhi];
          if(Array.isArray(v)) return v.join('');
          return String(v).replace(/,/g,'');
        }
      }
    }catch(e){}
    return ZHI_HIDE_FALLBACK[zhi] || '';
  }

  function nayinForGanZhi(gz){
    try{
      if(typeof LunarUtil !== 'undefined'){
        const map = LunarUtil.NAYIN || LunarUtil.NAYIN_MAP;
        if(map && map[gz]) return map[gz];
      }
    }catch(e){}
    return '';
  }

  function shiShenForHidden(dayGan, hideStr){
    if(!hideStr) return '';
    const gans = hideStr.split('');
    const mapped = gans.map(g => {
      const ss = shiShenForGan(dayGan, g);
      return ss ? `${g}${ss}` : g;
    });
    return mapped.join(' ');
  }

  function buildPillarSub(dayGan, pillarGan, pillarZhi){
    const ss = shiShenForGan(dayGan, pillarGan);
    const hide = hiddenGansForZhi(pillarZhi);
    const hideSS = shiShenForHidden(dayGan, hide);
    const nayin = nayinForGanZhi(pillarGan + pillarZhi);

    const parts = [];
    if(ss) parts.push(`天干十神：<span class="hl">${ss}</span>`);
    if(hide) parts.push(`藏干：${hide}`);
    if(hideSS) parts.push(`藏干十神：<span class="hl2">${hideSS}</span>`);
    if(nayin) parts.push(`纳音：${nayin}`);

    return parts.join('<br/>') || '—';
  }

  /* ===================== 节气 ===================== */
  function jieQiNameForSolar(solar){
    try{
      if(solar && typeof solar.getJieQi === 'function'){
        const n = solar.getJieQi();
        if(n) return n;
      }
    }catch(e){}
    try{
      const lunar = solar ? solar.getLunar() : null;
      if(lunar && typeof lunar.getJieQi === 'function'){
        const n = lunar.getJieQi();
        if(n) return n;
      }
    }catch(e){}
    return '';
  }

  function findNextJieQi(date){
    for(let i=1;i<=80;i++){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()+i, 12, 0, 0);
      try{
        const s = Solar.fromYmdHms(d.getFullYear(), d.getMonth()+1, d.getDate(), 12, 0, 0);
        const name = jieQiNameForSolar(s);
        if(name){
          return { name, date: d, offset: i };
        }
      }catch(e){}
    }
    return null;
  }

  function findPrevJieQi(date){
    for(let i=1;i<=80;i++){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()-i, 12, 0, 0);
      try{
        const s = Solar.fromYmdHms(d.getFullYear(), d.getMonth()+1, d.getDate(), 12, 0, 0);
        const name = jieQiNameForSolar(s);
        if(name){
          return { name, date: d, offset: -i };
        }
      }catch(e){}
    }
    return null;
  }

  function renderJieQiSection(date){
    const line = [];
    let todayName = '';
    try{
      const s = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), 12, 0, 0);
      todayName = jieQiNameForSolar(s);
    }catch(e){}

    if(todayName){
      line.push(`<span class="jieqi-badge">今日节气：${todayName}</span>`);
    }else{
      line.push(`<span class="jieqi-badge">今日无节气点</span>`);
    }

    const prev = findPrevJieQi(date);
    const next = findNextJieQi(date);

    if(prev){
      const abs = Math.abs(prev.offset);
      line.push(`上一节气：<b style="color:var(--accent-2)">${prev.name}</b> · ${fmtMD(prev.date)}（${abs} 天前）`);
    }else{
      line.push(`上一节气：暂未定位`);
    }

    if(next){
      line.push(`下一节气：<b style="color:var(--accent-2)">${next.name}</b> · ${fmtMD(next.date)}（${next.offset} 天后）`);
    }else{
      line.push(`下一节气：暂未定位`);
    }

    line.push(`<span style="font-size:10.5px; color:#8b90a1;">节气日期按设备时区近似展示（${getTZ()}）</span>`);
    els.jieqiLine.innerHTML = line.join('<br/>');
  }

  /* ===================== 神煞（试行版自动判定） ===================== */
  const GROUPS = {
    '申子辰': ['申','子','辰'],
    '巳酉丑': ['巳','酉','丑'],
    '寅午戌': ['寅','午','戌'],
    '亥卯未': ['亥','卯','未']
  };

  // v10.4: 孤辰/寡宿等以年支为主的分组（四库方向）
  const YEAR_SOLITUDE_GROUPS = {
    '亥子丑': ['亥','子','丑'],
    '寅卯辰': ['寅','卯','辰'],
    '巳午未': ['巳','午','未'],
    '申酉戌': ['申','酉','戌']
  };

  function findYearSolitudeGroup(yearZhi){
    if(!yearZhi) return null;
    for(const k of Object.keys(YEAR_SOLITUDE_GROUPS)){
      if(YEAR_SOLITUDE_GROUPS[k].includes(yearZhi)) return k;
    }
    return null;
  }

  const GUCHEN_YEAR_MAP = {
    '亥子丑': '寅',
    '寅卯辰': '巳',
    '巳午未': '申',
    '申酉戌': '亥'
  };

  const GUASU_YEAR_MAP = {
    '亥子丑': '戌',
    '寅卯辰': '丑',
    '巳午未': '辰',
    '申酉戌': '未'
  };


  const TAOHUA_MAP = {
    '申子辰': '酉',
    '巳酉丑': '午',
    '寅午戌': '卯',
    '亥卯未': '子'
  };
  const YIMA_MAP = {
    '申子辰': '寅',
    '寅午戌': '申',
    '亥卯未': '巳',
    '巳酉丑': '亥'
  };
  const HUAGAI_MAP = {
    '申子辰': '辰',
    '寅午戌': '戌',
    '亥卯未': '未',
    '巳酉丑': '丑'
  };
  const JIANGXING_MAP = {
    '申子辰': '子',
    '寅午戌': '午',
    '亥卯未': '卯',
    '巳酉丑': '酉'
  };

  // v10.4: 以年支/日支三合局为主的凶煞/桃花类扩展
  const WANGSHEN_MAP = {
    '寅午戌': '巳',
    '亥卯未': '寅',
    '巳酉丑': '申',
    '申子辰': '亥'
  };

  const LIUE_MAP = {
    '寅午戌': '酉',
    '亥卯未': '午',
    '申子辰': '卯',
    '巳酉丑': '子'
  };

  const ZAISHA_MAP = {
    '申子辰': '午',
    '亥卯未': '酉',
    '寅午戌': '子',
    '巳酉丑': '卯'
  };

  const JIESHA_MAP = {
    '申子辰': '亥',
    '寅午戌': '巳',
    '巳酉丑': '寅',
    '亥卯未': '申'
  };

  const BAIHU_MAP = {
    '寅午戌': '子',
    '申子辰': '午',
    '亥卯未': '酉',
    '巳酉丑': '卯'
  };


  /* ===================== 神煞自动判定 · 扩展版（含干支/日柱类） ===================== */

  const WENCHANG_MAP = {
    '甲':'巳','乙':'午','丙':'申','丁':'酉','戊':'申','己':'酉','庚':'亥','辛':'子','壬':'寅','癸':'卯'
  };

  const TIAN_YI_MAP = {
    '甲':['丑','未'],
    '戊':['丑','未'],
    '乙':['子','申'],
    '己':['子','申'],
    '丙':['亥','酉'],
    '丁':['亥','酉'],
    '壬':['卯','巳'],
    '癸':['卯','巳'],
    '庚':['寅','午'],
    '辛':['寅','午'] // 常见并用法，供学习参考
  };

  const GUOYIN_MAP = {
    '甲':'戌','乙':'亥','丙':'丑','丁':'寅','戊':'丑','己':'寅','庚':'辰','辛':'巳','壬':'未','癸':'申'
  };

  const TAIJI_MAP = {
    '甲':'子午','乙':'子午',
    '丙':'酉卯','丁':'酉卯',
    '戊':'辰戌丑未','己':'辰戌丑未',
    '庚':'寅亥','辛':'寅亥',
    '壬':'巳申','癸':'巳申'
  };

  const HONG_LUAN_MAP = {
    '子':'卯','丑':'寅','寅':'丑','卯':'子','辰':'亥','巳':'戌','午':'酉','未':'申','申':'未','酉':'午','戌':'巳','亥':'辰'
  };

  const TIAN_XI_MAP = {
    '子':'酉','丑':'申','寅':'未','卯':'午','辰':'巳','巳':'辰','午':'卯','未':'寅','申':'丑','酉':'子','戌':'亥','亥':'戌'
  };

  const LUSHEN_MAP = {
    '甲':'寅','乙':'卯','丙':'巳','丁':'午','戊':'巳','己':'午','庚':'申','辛':'酉','壬':'亥','癸':'子'
  };

  const FUDEREN_MAP = {
    '甲':'寅','乙':'卯','丙':'巳','丁':'午','戊':'申','己':'酉','庚':'亥','辛':'子','壬':'寅','癸':'卯'
  };

  // v10.4: 新增日干对应神煞
  const FUXING_MAP = {
    '甲':'寅', '丙':'寅',
    '乙':'卯', '癸':'卯',
    '丁':'亥',
    '戊':'申',
    '己':'未',
    '庚':'午',
    '辛':'巳',
    '壬':'辰'
  };

  const JINYU_MAP = {
    '甲':'辰','乙':'巳','丙':'未','丁':'申','戊':'未','己':'申','庚':'戌','辛':'亥','壬':'丑','癸':'寅'
  };

  const XISHEN_MAP = {
    '甲':'午','乙':'巳','丙':'寅','丁':'卯','戊':'申','己':'酉','庚':'亥','辛':'子','壬':'戌','癸':'丑'
  };

  const HONGYAN_MAP = {
    '甲':'午','乙':'申','丙':'寅','丁':'未','戊':'辰